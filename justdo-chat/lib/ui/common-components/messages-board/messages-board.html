<template name="common_chat_messages_board">
    <div class="messages-board-viewport">
      <div class="messages-board">
        {{#each messages}}
          {{#if showMsgSeperatorWithDate @index}}
            {{> chat_message_date_seperator}}
          {{/if}}

          {{#if isBotLogMessage}}
            {{> bot_log_chat_messages_board_message_card}}
          {{else}}
            {{> common_chat_messages_board_message_card}}
          {{/if}}
        {{/each}}
      </div>
    </div>
</template>

<template name="chat_message_date_seperator">
  <div class="message-date-seperator">
    <small class="text-secondary">{{formatMsgDate createdAt}}</small>
  </div>
</template>

<template name="bot_log_chat_messages_board_message_card">
  <div class="message-card bot-log-message">
    <div class="message-container">
      <div dir="auto" class="message-body">
        {{{body}}}
      </div>
    </div>
  </div>
</template>

<template name="common_chat_messages_board_message_card">
  <div class="message-card {{#if myMessage}}my-message{{/if}}">
    {{#if shouldShowAvatar}}
      <div class="avatar">{{#with authorDoc}}{{> justdo_avatar}}{{/with}}</div>
    {{/if}}

    <div class="message-card-content">
      {{#if $and isFilesEnabled fileExistsInMessage}}
        {{#with files}}
          <div class="files-container">
            <span class="date" title="{{userDateFormat createdAt}}">{{friendlyTimeFormat createdAt false}}</span>

            <div class="files-images-container {{#if shouldUseGridLayout}}grid-layout{{/if}}">
              {{#each existingMaxVisibleImageFiles existing_media_files}}
                {{> common_chat_messages_board_file_container}}
              {{/each}}

              <div class="hidden-image-wrapper">
                {{#if hiddenImageCount}}
                  <div class="hidden-image-count">
                    + {{hiddenImageCount}}
                  </div>
                {{/if}}
                {{#with lastVisibleImageFile}}
                  {{> common_chat_messages_board_file_container}}
                {{/with}}
              </div>
            </div>

            {{#each existing_not_media_files}}
              {{> common_chat_messages_board_file_container}}
            {{/each}}

            {{#each missing_files}}
              <div class="file-container">
                <div class="file-info">
                  <span class="type-logo {{typeClass}}"></span>
                  <div class="file-name-wrapper">
                    <span class="file-name">{{additional_details.name}}</span>
                    <span class="file-size">{{size}}({{_ "inbound_emails_file_removed"}})</span>
                  </div>
                </div>
              </div>
            {{/each}}

          </div>
        {{/with}}
      {{/if}}

      {{#if body}}
        <div class="message-container {{#if myMessage}}bg-primary{{/if}}">
          <div class="message-header">
            {{#if shouldShowAuthorName}}
              <span class="author">
                  {{> display_name_with_graphic_unverified_warning authorDoc}}
              </span>
            {{/if}}
            <span class="date" title="{{userDateFormat createdAt}}">{{friendlyTimeFormat createdAt false}}</span>
          </div>
          <div dir="auto" class="message-body">
            {{{body}}}
          </div>
        </div>
      {{/if}}
    </div>
  </div>
</template>

<template name="common_chat_messages_board_file_container">
  <div class="file-container {{#unless isPreviewable}}non-previewable{{/unless}}">
    <a href="#" class="show-preview-or-start-download text-info" title="{{additional_details.name}}">
      {{#if isPreviewable}}
        {{#let previewLink=getFilePreviewLink file=this}}
          {{#if @pending "previewLink"}}
            <div class="loader">
              <div class="double-bounce1 bg-primary"></div>
              <div class="double-bounce2 bg-primary"></div>
            </div>
          {{/if}}
          {{!-- {{#if @rejected "previewLink"}}
            XXX Add error handling
          {{/if}} --}}
          {{#if @resolved "previewLink"}}
            {{#if isImage file.additional_details.type}}
              <div class="file-wrapper image">
                <div class="file-image" style="background: url('{{previewLink}}')" title="{{file.additional_details.name}}"></div>
              </div>
            {{else if isPdf file.additional_details.type}}
              <div class="file-wrapper pdf">
                <embed src="{{previewLink}}" type="{{file.additional_details.type}}" width="970" height="550" alt="{{file.additional_details.name}}" style="border: 0 none;">
              </div>
            {{else if isVideo file.additional_details.type}}
              <div class="file-wrapper video">
                <video alt="{{file.additional_details.name}}" preload="metadata">
                  <source src="{{previewLink}}">
                </video>
              </div>
            {{/if}}
          {{/if}}
        {{/let}}
      {{else}}
        <div class="file-info">
          <span class="type-logo {{typeClass}}"></span>
          <div class="file-name-wrapper">
            <span class="file-name">{{additional_details.name}}</span>
            <span class="file-size">{{size}}</span>
          </div>
        </div>
      {{/if}}
    </a>
  </div>
</template>
